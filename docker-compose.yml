
services:
  # -----------------------------------------------------------
  # Localstack (SQS + DynamoDB)
  # -----------------------------------------------------------
  localstack:
    image: localstack/localstack:3.0
    container_name: localstack
    environment:
      SERVICES: sqs,dynamodb
      AWS_DEFAULT_REGION: ${AWS_REGION}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
    ports:
      - "4566:4566"   # Porta padr√£o do LocalStack (tudo via edge)
    volumes:
      - localstack_data:/var/lib/localstack
      - ./localstack-init.sh:/etc/localstack/init/ready.d/localstack-init.sh
    networks:
      - togglemaster_net
  
  # -----------------------------------------------------------
  # Redis
  # -----------------------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "${REDIS_PORT}:${REDIS_PORT}"
    networks:
      - togglemaster_net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 5s

  # -----------------------------------------------------------
  # Auth Service + PostgreSQL
  # -----------------------------------------------------------
  auth-db:
    image: postgres:15-alpine
    container_name: auth-db
    environment:
      POSTGRES_USER: ${AUTH_DB_USER}
      POSTGRES_PASSWORD: ${AUTH_DB_PASS}
      POSTGRES_DB: ${AUTH_DB_NAME}
    ports:
      - "${AUTH_DB_PORT}:5432"
    volumes:
      - ./auth-service/db/init.sql:/docker-entrypoint-initdb.d/init.sql
      - auth_db_data:/var/lib/postgresql/data
    networks:
      - togglemaster_net
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "${AUTH_DB_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5

  auth-service:
    build: ./auth-service
    image: rivachef/auth-service:v1
    container_name: auth-service
    restart: always
    environment:
      PORT: ${AUTH_PORT}
      MASTER_KEY: ${MASTER_KEY}
      DATABASE_URL: postgres://${AUTH_DB_USER}:${AUTH_DB_PASS}@${AUTH_DB_HOST}:5432/${AUTH_DB_NAME}
    depends_on:
      auth-db:
        condition: service_healthy
    ports:
      - "8001:8001"
    networks:
      - togglemaster_net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      retries: 3
      timeout: 5s

  # -----------------------------------------------------------
  # Flag Service + PostgreSQL
  # -----------------------------------------------------------
  flag-db:
    image: postgres:15-alpine
    container_name: flag-db
    environment:
      POSTGRES_USER: ${FLAG_DB_USER}
      POSTGRES_PASSWORD: ${FLAG_DB_PASS}
      POSTGRES_DB: ${FLAG_DB_NAME}
    ports:
      - "${FLAG_DB_PORT}:5432"
    volumes:
      - ./flag-service/db/init.sql:/docker-entrypoint-initdb.d/init.sql
      - flag_db_data:/var/lib/postgresql/data
    networks:
      - togglemaster_net
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "${FLAG_DB_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5

  flag-service:
    build: ./flag-service
    image: rivachef/flag-service:v1
    container_name: flag-service
    environment:
      PORT: ${FLAG_PORT}
      DATABASE_URL: postgres://${FLAG_DB_USER}:${FLAG_DB_PASS}@${FLAG_DB_HOST}:5432/${FLAG_DB_NAME}
      AUTH_SERVICE_URL: ${AUTH_SERVICE_URL}
    depends_on:
      flag-db:
        condition: service_healthy
      auth-service:
        condition: service_healthy
    ports:
      - "${FLAG_PORT}:${FLAG_PORT}"
    networks:
      - togglemaster_net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 30s
      retries: 3
      timeout: 5s

  # -----------------------------------------------------------
  # Targeting Service + PostgreSQL
  # -----------------------------------------------------------
  targeting-db:
    image: postgres:15-alpine
    container_name: targeting-db
    environment:
      POSTGRES_USER: ${TARGETING_DB_USER}
      POSTGRES_PASSWORD: ${TARGETING_DB_PASS}
      POSTGRES_DB: ${TARGETING_DB_NAME}
    ports:
      - "${TARGETING_DB_PORT}:5432"
    volumes:
      - ./targeting-service/db/init.sql:/docker-entrypoint-initdb.d/init.sql
      - targeting_db_data:/var/lib/postgresql/data
    networks:
      - togglemaster_net
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "${TARGETING_DB_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5
  
  targeting-service:
    build: ./targeting-service
    image: rivachef/targeting-service:v1
    container_name: targeting-service
    environment:
      PORT: ${TARGETING_PORT}
      DATABASE_URL: postgres://${TARGETING_DB_USER}:${TARGETING_DB_PASS}@${TARGETING_DB_HOST}:5432/${TARGETING_DB_NAME}
      AUTH_SERVICE_URL: ${AUTH_SERVICE_URL}
    depends_on:
      targeting-db:
        condition: service_healthy
      auth-service:
        condition: service_healthy
    ports:
      - "${TARGETING_PORT}:${TARGETING_PORT}"
    networks:
      - togglemaster_net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8003/health"]
      interval: 30s
      retries: 3
      timeout: 5s

  # -----------------------------------------------------------
  # Evaluation Service
  # -----------------------------------------------------------
  evaluation-service:
    build: ./evaluation-service
    image: rivachef/evaluation-service:v1
    container_name: evaluation-service
    environment:
      PORT: "${EVALUATION_PORT}"
      REDIS_URL: ${REDIS_URL}
      FLAG_SERVICE_URL: ${FLAG_SERVICE_URL}
      TARGETING_SERVICE_URL: ${TARGETING_SERVICE_URL}
      SERVICE_API_KEY: ${SERVICE_API_KEY}
      AWS_SQS_URL: "http://localstack:4566/000000000000/evaluation-events"
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      AWS_REGION: ${AWS_REGION}
    depends_on:
      flag-service:
        condition: service_healthy
      targeting-service:
        condition: service_healthy
      redis:
        condition: service_healthy
      localstack:
        condition: service_healthy
    ports:
      - "${EVALUATION_PORT}:${EVALUATION_PORT}"
    networks:
      - togglemaster_net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8004/health"]
      interval: 30s
      retries: 3
      timeout: 5s

  # -----------------------------------------------------------
  # Analytics Service
  # -----------------------------------------------------------
  analytics-service:
    build: ./analytics-service
    image: rivachef/analytics-service:v1
    container_name: analytics-service
    environment:
      PORT: ${ANALYTICS_PORT}
      AWS_SQS_URL: "http://localstack:4566/000000000000/analytics-queue"
      AWS_DYNAMODB_TABLE: ${DYNAMO_TABLE}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      AWS_REGION: ${AWS_REGION}
      AWS_SQS_ENDPOINT: http://localstack:4566
      AWS_DYNAMODB_ENDPOINT: http://localstack:4566
    depends_on:
      evaluation-service:
        condition: service_healthy
      localstack:
        condition: service_healthy
    ports:
      - "${ANALYTICS_PORT}:${ANALYTICS_PORT}"
    networks:
      - togglemaster_net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8005/health"]
      interval: 30s
      retries: 3
      timeout: 5s

# -------------------------
# Volumes
# -------------------------
volumes:
  localstack_data:
  auth_db_data:
  flag_db_data:
  targeting_db_data:

# -------------------------
# Networks
# -------------------------
networks:
  togglemaster_net:
    driver: bridge
